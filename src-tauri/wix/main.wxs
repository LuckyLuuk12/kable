<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?if $(sys.BUILDARCH)="x86"?>
    <?define Win64 = "no" ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?elseif $(sys.BUILDARCH)="x64"?>
    <?define Win64 = "yes" ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?elseif $(sys.BUILDARCH)="arm64"?>
    <?define Win64 = "yes" ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else?>
    <?error Unsupported value of sys.BUILDARCH=$(sys.BUILDARCH)?>
  <?endif?>
  
  <Product
    Id="*"
    Name="{{product_name}}"
    Language="!(loc.Language)"
    Version="{{version}}"
    Manufacturer="{{manufacturer}}"
    UpgradeCode="{{upgrade_code}}">
    
    <Package
      InstallerVersion="450"
      Compressed="yes"
      InstallScope="perMachine"
      Description="Kable - A Modern Minecraft Launcher"
      Comments="Visit https://kable.kablan.nl for more information" />

    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of [ProductName] is already installed. Setup will now exit." />

    <MediaTemplate EmbedCab="yes" />

    <!-- Custom UI with images - force overrides -->
    <WixVariable Id="WixUILicenseRtf" Value="wix\licenses\License_!(loc.Locale).rtf" Overridable="no" />
    <WixVariable Id="WixUIDialogBmp" Value="wix\img\dialog.bmp" Overridable="no" />
    <WixVariable Id="WixUIBannerBmp" Value="wix\img\banner.bmp" Overridable="no" />

    <!-- Use built-in InstallDir UI with custom images -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    
    <UIRef Id="WixUI_InstallDir" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="DesktopFolder" Name="Desktop" />
      <Directory Id="$(var.PlatformProgramFilesFolder)">
        <Directory Id="INSTALLDIR" Name="{{product_name}}" />
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="{{product_name}}" />
      </Directory>
    </Directory>

    <!-- Feature to install -->
    <Feature
      Id="MainApplication"
      Title="{{product_name}}"
      Description="The complete {{product_name}} application."
      Level="1"
      ConfigurableDirectory="INSTALLDIR"
      AllowAdvertise="no"
      Display="expand"
      Absent="disallow">
      
      <ComponentRef Id="Path" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      {{#each resource_file_ids as |resource_file_id| ~}}
      <ComponentRef Id="{{resource_file_id}}" />
      {{/each~}}
    </Feature>

    <!-- Main executable component -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="Path" Guid="*" Win64="$(var.Win64)">
        <File Id="Path" Source="{{app_exe_source}}" KeyPath="yes" Checksum="yes" />
      </Component>
      {{resources}}
    </DirectoryRef>

    <!-- Start Menu Shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="*">
        <Shortcut
          Id="ApplicationStartMenuShortcut"
          Name="{{product_name}}"
          Description="{{product_name}}"
          Target="[!Path]"
          WorkingDirectory="INSTALLDIR"
          Icon="ProductIcon" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue
          Root="HKCU"
          Key="Software\{{manufacturer}}\{{product_name}}"
          Name="installed"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Desktop Shortcut -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut
          Id="ApplicationDesktopShortcut"
          Name="{{product_name}}"
          Description="{{product_name}}"
          Target="[!Path]"
          WorkingDirectory="INSTALLDIR"
          Icon="ProductIcon" />
        <RemoveFolder Id="DesktopFolder" On="uninstall" />
        <RegistryValue
          Root="HKCU"
          Key="Software\{{manufacturer}}\{{product_name}}"
          Name="desktopShortcut"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <Icon Id="ProductIcon" SourceFile="{{icon_path}}" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />

    <Property Id="ARPHELPLINK" Value="https://github.com/LuckyLuuk12/kable/wiki" />
    <Property Id="ARPURLINFOABOUT" Value="https://kable.kablan.nl" />
    <Property Id="ARPURLUPDATEINFO" Value="https://github.com/LuckyLuuk12/kable/releases" />

  </Product>
</Wix>
